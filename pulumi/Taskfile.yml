version: "3"

includes:
  projects:
    taskfile: projects/Taskfile.yml
    dir: projects
    internal: true

tasks:
  run-all-backup-jobs:*:
    vars:
      STACK: "{{index .MATCH 0}}"
    desc: Run all backup jobs in {{.STACK}} and wait for them to finish
    cmds:
      - ./scripts/run-backup-jobs.sh {{.STACK}}

  run-backup-jobs:*:*:
    vars:
      STACK: "{{index .MATCH 0}}"
      PROJECT: "{{index .MATCH 1}}"
    label: backup {{.PROJECT}} in {{.STACK}}
    desc: Run all backup jobs in {{.STACK}} for {{.PROJECT}} and wait for them to finish
    cmds:
      - ./scripts/run-backup-jobs.sh {{.STACK}} {{.PROJECT}}

  bootstrap:network:*:
    desc: Bootstrap the network infrastructure
    vars:
      STACK: "{{index .MATCH 0}}"
    label: bootstrap {{.STACK}}/network
    cmds:
      - task: projects:up:{{.STACK}}:shared
      - ./scripts/wait-for-dns.sh k8s.{{.STACK}}.exeteres.me
      - task: projects:up:{{.STACK}}:cilium

  bootstrap:base:*:
    desc: Bootstrap the base infrastructure
    vars:
      STACK: "{{index .MATCH 0}}"
    label: bootstrap {{.STACK}}/base
    deps:
      - task: projects:non-interactive:up:{{.STACK}}:cert-manager
      - task: projects:non-interactive:up:{{.STACK}}:internal-gateway
      - task: projects:non-interactive:up:{{.STACK}}:public-gateway

  bootstrap:initial:*:
    vars:
      STACK: "{{index .MATCH 0}}"
    desc: Bootstrap the initial infrastructure
    label: bootstrap {{.STACK}}
    cmds:
      - task: bootstrap:network:{{.STACK}}
      - task: bootstrap:base:{{.STACK}}
      - task: projects:up:{{.STACK}}:kubernetes-dashboard

  destroy:initial:*:
    vars:
      STACK: "{{index .MATCH 0}}"
    desc: Destroy the initial infrastructure
    label: destroy {{.STACK}}
    deps:
      - task: projects:non-interactive:down:{{.STACK}}:kubernetes-dashboard
      - task: projects:non-interactive:down:{{.STACK}}:public-gateway
      - task: projects:non-interactive:down:{{.STACK}}:internal-gateway
      - task: projects:non-interactive:down:{{.STACK}}:cert-manager
      - task: projects:non-interactive:down:{{.STACK}}:cilium
      - task: projects:non-interactive:down:{{.STACK}}:shared
    ignore_error: true

  migrate:all:*:*:
    vars:
      SOURCE: "{{index .MATCH 0}}"
      TARGET: "{{index .MATCH 1}}"
    desc: Migrate all projects from "{{.SOURCE}}" to "{{.TARGET}}"
    cmds:
      # 1. Migrate VPN stuff
      - task: migrate:vpn:{{.SOURCE}}:{{.TARGET}}

      # 2. Up databases on the target
      - task: migrate:backup-and-up-databases:{{.SOURCE}}:{{.TARGET}}

      # 3. Migrate apps
      - task: migrate:apps:{{.SOURCE}}:{{.TARGET}}

      # 4. Down databases on the source
      - task: migrate:down-databases:{{.SOURCE}}

  migrate:vpn:*:*:
    vars:
      SOURCE: "{{index .MATCH 0}}"
      TARGET: "{{index .MATCH 1}}"
    desc: Migrate VPN exit nodes and static listeners from "{{.SOURCE}}" to "{{.TARGET}}"
    deps:
      - task: projects:stop:migrate:{{.SOURCE}}:{{.TARGET}}:vpn
      - task: projects:migrate:{{.SOURCE}}:{{.TARGET}}:vpn-static

  migrate:backup-and-up:*:*:*:
    vars:
      SOURCE: "{{index .MATCH 0}}"
      TARGET: "{{index .MATCH 1}}"
      PROJECT: "{{index .MATCH 2}}"
    desc: Backup data from "{{.SOURCE}}" and up the project on "{{.TARGET}}"
    cmds:
      - task: run-backup-jobs:{{.SOURCE}}:{{.PROJECT}}
      - task: projects:non-interactive:up:{{.TARGET}}:{{.PROJECT}}

  migrate:backup-and-up-databases:*:*:
    vars:
      SOURCE: "{{index .MATCH 0}}"
      TARGET: "{{index .MATCH 1}}"
    desc: Backup databases from "{{.SOURCE}}" and up them on "{{.TARGET}}"
    deps:
      - task: migrate:backup-and-up:{{.SOURCE}}:{{.TARGET}}:postgresql
      - task: migrate:backup-and-up:{{.SOURCE}}:{{.TARGET}}:mariadb
      - task: migrate:backup-and-up:{{.SOURCE}}:{{.TARGET}}:minio

  migrate:down-databases:*:
    vars:
      TARGET: "{{index .MATCH 0}}"
    desc: Down databases on "{{.TARGET}}"
    deps:
      - task: projects:non-interactive:down:{{.TARGET}}:postgresql
      - task: projects:non-interactive:down:{{.TARGET}}:mariadb
      - task: projects:non-interactive:down:{{.TARGET}}:minio

  migrate:apps:*:*:
    vars:
      SOURCE: "{{index .MATCH 0}}"
      TARGET: "{{index .MATCH 1}}"
    desc: Migrate apps from "{{.SOURCE}}" to "{{.TARGET}}"
    deps:
      - task: projects:migrate:{{.SOURCE}}:{{.TARGET}}:vaultwarden
      - task: projects:migrate:{{.SOURCE}}:{{.TARGET}}:plane
      - task: projects:migrate:{{.SOURCE}}:{{.TARGET}}:ghost
      - task: projects:migrate:{{.SOURCE}}:{{.TARGET}}:etebase

  refresh:*:
    vars:
      STACK: "{{index .MATCH 0}}"
    desc: Refresh all projects in {{.STACK}}
    deps:
      - task: projects:non-interactive:refresh:{{.STACK}}:cert-manager
      - task: projects:non-interactive:refresh:{{.STACK}}:cilium
      - task: projects:non-interactive:refresh:{{.STACK}}:etebase
      - task: projects:non-interactive:refresh:{{.STACK}}:ghost
      - task: projects:non-interactive:refresh:{{.STACK}}:internal-gateway
      - task: projects:non-interactive:refresh:{{.STACK}}:kubernetes-dashboard
      - task: projects:non-interactive:refresh:{{.STACK}}:mailu
      - task: projects:non-interactive:refresh:{{.STACK}}:mariadb
      - task: projects:non-interactive:refresh:{{.STACK}}:minio
      - task: projects:non-interactive:refresh:{{.STACK}}:plane
      - task: projects:non-interactive:refresh:{{.STACK}}:postgresql
      - task: projects:non-interactive:refresh:{{.STACK}}:public-gateway
      - task: projects:non-interactive:refresh:{{.STACK}}:vpn
      - task: projects:non-interactive:refresh:{{.STACK}}:vpn-static
    ignore_error: true
